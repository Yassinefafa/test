<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <style>
    body { margin: 0; font-family: Arial; background-color: #f4f4f4; direction: ltr; }
    .login-page, .main-page { display: none; height: 100vh; }
    .login-page { display: flex; justify-content: center; align-items: center; background: #0f3057; color: white; }
    .login-box { background: #2c82c9; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px #000; }
    .login-box input { width: 100%; margin: 10px 0; padding: 10px; }
    .sidebar { width: 220px; background: #2c3e50; color: white; position: fixed; height: 100%; padding-top: 20px; left: 0; text-align: left; }
    .sidebar button { display: block; background: none; color: white; border: none; width: 100%; text-align: left; padding: 15px; cursor: pointer; transition: background 0.3s; }
    .sidebar button:hover { background: #34495e; }
    .sidebar .bottom-buttons { position: absolute; bottom: 20px; width: 100%; }
    .content { margin-left: 220px; padding: 20px; }
    .filters { margin-bottom: 20px; }
    canvas { background: white; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
    #mainChart, #tableContainer { display: none; }
    #dataTable_wrapper { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 0 10px #ccc; }
  </style>
</head>
<body>
<div class="login-page" id="loginPage">
  <div class="login-box">
    <h2 id="login-title">Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button onclick="login()" id="login-button">Login</button>
  </div>
</div>

<div class="main-page" id="mainPage">
  <div class="sidebar">
    <button onclick="showChart('temp')">📈 Temperature</button>
    <button onclick="showChart('humidity')">💧 Humidity</button>
    <button onclick="showChart('accelX')">↔️ Acceleration X</button>
    <button onclick="showChart('accelY')">↕️ Acceleration Y</button>
    <button onclick="showChart('accelZ')">🔃 Acceleration Z</button>
    <button onclick="showChart('gyroX')">🧭 Gyroscope X</button>
    <button onclick="showChart('gyroY')">🧭 Gyroscope Y</button>
    <button onclick="showChart('gyroZ')">🧭 Gyroscope Z</button>
    <button onclick="showChart('vibration')">📳 Vibration</button>
    <button onclick="showChart('ntc')">🌡️ NTC Temp</button>
    <button onclick="showChart('courant')">⚡ Courant</button>
    <button onclick="showChart('battery')">🔋 Batterie</button>
    <button onclick="showTable()">📋 Full Table</button>
    <button onclick="downloadPDF()">🖨️ Export PDF</button>
    <div class="bottom-buttons">
      <button onclick="changeLang('ar')">🇲🇦 العربية</button>
      <button onclick="changeLang('fr')">🇫🇷 Français</button>
      <button onclick="changeLang('en')">🇬🇧 English</button>
      <button onclick="logout()" style="color: red;">🚪 Logout</button>
    </div>
  </div>
  <div class="content">
    <div class="filters">
      <label>Date:</label>
      <input type="date" id="dateFilter">
      <label>From:</label>
      <input type="time" id="timeFrom">
      <label>To:</label>
      <input type="time" id="timeTo">
      <button onclick="refreshData()">Refresh</button>
    </div>
    <canvas id="mainChart" width="1000" height="400"></canvas>
    <div id="tableContainer">
      <table id="dataTable" class="display"></table>
    </div>
  </div>
</div>

<script>
  function logout() {
    document.getElementById("mainPage").style.display = "none";
    document.getElementById("loginPage").style.display = "flex";
  }

  function login() {
    const user = document.getElementById("username").value;
    const pass = document.getElementById("password").value;
    if (user === "admin" && pass === "admin") {
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("mainPage").style.display = "block";
      refreshData();
    } else {
      alert("Incorrect login credentials");
    }
  }

  async function refreshData() {
    const url = "https://script.google.com/macros/s/AKfycbyyOjiF-mX-oC2AeYB2antb3GMRKsMLfzegN6DRx5Q_XsceQMNOjAipsAMyxPI3Ca2NDA/exec";
    const response = await fetch(url);
    const data = await response.json();
    window.sensorData = data.filter(row => row["Température (°C)"].includes("Temp"));
    showChart('temp');
  }

  function showChart(type) {
    const data = window.sensorData || [];
    const labels = data.map(row => new Date(row.Heure).toLocaleTimeString());
    let values = [], label = '', color = 'blue';

    const map = {
      temp: ["Température (°C)", "Température (°C)", "red"],
      humidity: ["Humidité (%)", "Humidité (%)", "blue"],
      accelX: ["Accélération X", "Accélération X", "green"],
      accelY: ["Accélération Y", "Accélération Y", "darkgreen"],
      accelZ: ["Accélération Z", "Accélération Z", "lightgreen"],
      gyroX: ["Gyroscope X", "Gyroscope X", "purple"],
      gyroY: ["Gyroscope Y", "Gyroscope Y", "darkpurple"],
      gyroZ: ["Gyroscope Z", "Gyroscope Z", "violet"],
      vibration: ["Vibration", "Vibration", "orange"],
      ntc: ["Temp. NTC (°C)", "Temp. NTC (°C)", "brown"],
      courant: ["Courant (V Bruts)", "Courant (V Bruts)", "black"],
      battery: ["Batterie (V)", "Batterie (V)", "gray"]
    };

    if (!map[type]) return alert("Chart not supported");
    const [key, labelText, clr] = map[type];
    label = labelText;
    color = clr;
    values = data.map(row => parseFloat((row[key] || '').match(/[-+]?\d+(\.\d+)?/g)?.[0] || 0));

    const ctx = document.getElementById('mainChart').getContext('2d');
    if (window.myChart) window.myChart.destroy();
    window.myChart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label, data: values, borderColor: color, fill: false }] },
      options: { responsive: true, scales: { y: { beginAtZero: false } }, animation: false }
    });

    document.getElementById('mainChart').style.display = 'block';
    document.getElementById('tableContainer').style.display = 'none';
  }

  function showTable() {
    const data = window.sensorData || [];
    const headers = Object.keys(data[0] || {});
    const columns = headers.map(h => ({ title: h, data: h }));
    $('#dataTable').DataTable({
      destroy: true,
      data,
      columns,
      deferRender: true,
      scrollY: 400,
      scroller: true,
      language: { url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/English.json' }
    });
    document.getElementById('mainChart').style.display = 'none';
    document.getElementById('tableContainer').style.display = 'block';
  }

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("Sensor Chart Report", 20, 20);
    doc.addImage(window.myChart.toBase64Image(), 'PNG', 10, 30, 180, 80);
    doc.save("chart-report.pdf");
  }
</script>
</body>
</html>
