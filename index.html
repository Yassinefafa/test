<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Login Page -->
  <div id="loginPage" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
      <h2 class="text-2xl font-semibold text-center text-gray-800 mb-6">Connexion SÃ©curisÃ©e</h2>
      <input id="loginUser" type="text" placeholder="Nom d'utilisateur" class="w-full mb-4 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
      <input id="loginPass" type="password" placeholder="Mot de passe" class="w-full mb-6 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700">Connexion</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <aside class="bg-gray-800 text-white w-64 space-y-4 py-6 px-4 flex flex-col justify-between">
        <nav class="space-y-2">
          <a href="#" onclick="showPage('home')" class="block px-4 py-2 rounded hover:bg-blue-600">ğŸ  Accueil</a>
          <a href="#" onclick="showPage('dashboard')" class="block px-4 py-2 rounded hover:bg-blue-600">ğŸ“Š Dashboard</a>
          <a href="#" onclick="showPage('settings')" class="block px-4 py-2 rounded hover:bg-blue-600">âš™ï¸ ParamÃ¨tres</a>
          <a href="#" onclick="showPage('graph')" class="block px-4 py-2 rounded hover:bg-blue-600">ğŸ“ˆ Graphiques</a>
        </nav>
        <button onclick="logout()" class="w-full bg-red-600 py-2 rounded-md text-white font-bold hover:bg-red-700">ğŸšª DÃ©connexion</button>
      </aside>

      <!-- Main Section -->
      <main class="flex-1 overflow-y-auto p-8">
        <section id="home" class="">
          <h2 class="text-2xl font-bold mb-4">Bienvenue</h2>
          <p>SÃ©lectionnez une section pour afficher les donnÃ©es.</p>
        </section>

        <section id="dashboard" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Tableau de bord</h2>
          <iframe src="https://docs.google.com/spreadsheets/d/1tqB-t3cDJiDhAHsgSGWJw7p4-pnE8pHHqubPHIStZ8c" class="w-full h-[600px] border rounded"></iframe>
        </section>

        <section id="settings" class="hidden">
          <h2 class="text-2xl font-bold mb-6">ParamÃ¨tres du compte</h2>

          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Changer le mot de passe</h3>
            <input type="password" placeholder="Nouveau mot de passe" class="w-full mb-2 px-4 py-2 border rounded">
            <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Modifier</button>
          </div>

          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Mettre Ã  jour le nom d'utilisateur</h3>
            <input type="text" placeholder="Nouveau nom d'utilisateur" class="w-full mb-2 px-4 py-2 border rounded">
            <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Mettre Ã  jour</button>
          </div>

          <div>
            <h3 class="text-lg font-semibold mb-2">Gestion des utilisateurs</h3>
            <input type="text" placeholder="Nom d'utilisateur" class="w-full mb-2 px-4 py-2 border rounded">
            <input type="password" placeholder="Mot de passe" class="w-full mb-2 px-4 py-2 border rounded">
            <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Ajouter</button>
          </div>
        </section>

        <!-- Section des Graphiques -->
        <section id="graph" class="hidden">
          <h2 class="text-2xl font-bold mb-6">Graphiques en Temps RÃ©el</h2>

          <!-- Filtre de temps -->
          <div class="flex flex-col md:flex-row items-center gap-4 mb-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">De (date et heure)</label>
              <input type="datetime-local" id="startTime" class="border rounded px-3 py-2 w-full md:w-60">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Ã€ (date et heure)</label>
              <input type="datetime-local" id="endTime" class="border rounded px-3 py-2 w-full md:w-60">
            </div>
            <button onclick="filterData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Appliquer</button>
          </div>

          <!-- Les Graphiques -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <canvas id="humiditeChart"></canvas>
            <canvas id="temperatureChart"></canvas>
            <canvas id="vibrationChart"></canvas>
            <canvas id="acceleroChart"></canvas>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    let originalData = [];
    let charts = {};  // Ù„Ø­ÙØ¸ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©

    // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function fetchData() {
      const response = await fetch("https://script.google.com/macros/s/AKfycby8FB58JbAnePfafVoZNfCGu6m9ie3_01u0SMVH310YYUZUWutx8Nla3noNW3HT0gCK/exec");
      const rawData = await response.json();

      // ØªÙ†Ø¸ÙŠÙ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      const cleanedData = rawData.map(item => {
        const date = new Date(item.Date);
        const time = new Date(item.Heure);
        
        const timestamp = new Date(
          date.getFullYear(), date.getMonth(), date.getDate(),
          time.getHours(), time.getMinutes(), time.getSeconds()
        );

        return {
          timestamp: timestamp.toISOString(),
          humidite: parseFloat(item["HumiditÃ© "] || 0),
          temperature: parseFloat(item["TempÃ©rature"] || 0),
          vibration: parseFloat(item["Vibration "] || 0),
          // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„ØªØ³Ø§Ø±Ø¹ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Accel_X, Accel_Y, Accel_Z
          accelero: Math.sqrt(
            Math.pow(item["Accel_X "] || 0, 2) +
            Math.pow(item["Accel_Y"] || 0, 2) +
            Math.pow(item["Accel_Z "] || 0, 2)
          )
        };
      });

      originalData = cleanedData;
      updateCharts(cleanedData);  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠØ©
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    function updateCharts(data) {
      const labels = data.map(item => item.timestamp);
      const humidite = data.map(item => item.humidite);
      const temperature = data.map(item => item.temperature);
      const vibration = data.map(item => item.vibration);
      const accelero = data.map(item => item.accelero);

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ«Ù‡Ø§
      if (charts['humiditeChart']) charts['humiditeChart'].destroy();
      if (charts['temperatureChart']) charts['temperatureChart'].destroy();
      if (charts['vibrationChart']) charts['vibrationChart'].destroy();
      if (charts['acceleroChart']) charts['acceleroChart'].destroy();

      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      charts['humiditeChart'] = new Chart(document.getElementById('humiditeChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'HumiditÃ© (%)',
            data: humidite,
            borderColor: '#3b82f6',
            backgroundColor: '#3b82f633',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
          }
        }
      });

      charts['temperatureChart'] = new Chart(document.getElementById('temperatureChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'TempÃ©rature (Â°C)',
            data: temperature,
            borderColor: '#ef4444',
            backgroundColor: '#ef444433',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
          }
        }
      });

      charts['vibrationChart'] = new Chart(document.getElementById('vibrationChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Vibration',
            data: vibration,
            borderColor: '#f59e0b',
            backgroundColor: '#f59e0b33',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
          }
        }
      });

      charts['acceleroChart'] = new Chart(document.getElementById('acceleroChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Accelero',
            data: accelero,
            borderColor: '#10b981',
            backgroundColor: '#10b98133',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
          }
        }
      });
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    function filterData() {
      const start = new Date(document.getElementById('startTime').value);
      const end = new Date(document.getElementById('endTime').value);

      const filtered = originalData.filter(item => {
        const timestamp = new Date(item.timestamp);
        return timestamp >= start && timestamp <= end;
      });

      updateCharts(filtered);  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    function login() {
      const username = document.getElementById('loginUser').value;
      const password = document.getElementById('loginPass').value;
      if (username === 'admin' && password === 'password') {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        fetchData();
      } else {
        alert('Identifiants incorrects');
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    function logout() {
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    }

    // Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª
    function showPage(id) {
      const sections = document.querySelectorAll('main > section');
      sections.forEach(section => section.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }
  </script>
</body>
</html>
