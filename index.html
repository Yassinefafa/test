<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Login Page -->
  <div id="loginPage" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
      <h2 class="text-2xl font-semibold text-center text-gray-800 mb-6">Connexion Sécurisée</h2>
      <input id="loginUser" type="text" placeholder="Nom d'utilisateur" class="w-full mb-4 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
      <input id="loginPass" type="password" placeholder="Mot de passe" class="w-full mb-6 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700">Connexion</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <aside id="sidebar" class="bg-gray-800 text-white space-y-4 py-6 px-4 flex flex-col justify-between transform transition-all duration-300 ease-in-out md:w-64 fixed inset-0 md:static md:flex md:h-auto z-10">
        <button id="sidebarToggle" class="text-white md:hidden absolute top-4 left-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-8 w-8">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <nav class="space-y-2">
          <a href="#" onclick="showPage('home')" class="block px-4 py-2 rounded hover:bg-blue-600">🏠 Accueil</a>
          <a href="#" onclick="showPage('dashboard')" class="block px-4 py-2 rounded hover:bg-blue-600">📊 Dashboard</a>
          <a href="#" onclick="showPage('settings')" class="block px-4 py-2 rounded hover:bg-blue-600">⚙️ Paramètres</a>
          <a href="#" onclick="showPage('graph')" class="block px-4 py-2 rounded hover:bg-blue-600">📈 Graphiques</a>
        </nav>
        <button onclick="logout()" class="w-full bg-red-600 py-2 rounded-md text-white font-bold hover:bg-red-700">🚪 Déconnexion</button>
      </aside>

      <!-- Main Section -->
      <main class="flex-1 overflow-y-auto p-4 ml-64 md:ml-0">
        <section id="home" class="">
          <h2 class="text-2xl font-bold mb-4">Bienvenue</h2>
          <p>Sélectionnez une section pour afficher les données.</p>
        </section>

        <section id="dashboard" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Tableau de bord</h2>
          <iframe src="https://docs.google.com/spreadsheets/d/1tqB-t3cDJiDhAHsgSGWJw7p4-pnE8pHHqubPHIStZ8c" class="w-full h-[500px] border rounded"></iframe>
        </section>

        <section id="settings" class="hidden">
          <h2 class="text-2xl font-bold mb-6">Paramètres du compte</h2>
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Changer le mot de passe</h3>
            <input type="password" placeholder="Nouveau mot de passe" class="w-full mb-2 px-4 py-2 border rounded">
            <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Modifier</button>
          </div>

          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Mettre à jour le nom d'utilisateur</h3>
            <input type="text" placeholder="Nouveau nom d'utilisateur" class="w-full mb-2 px-4 py-2 border rounded">
            <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Mettre à jour</button>
          </div>

          <div>
            <h3 class="text-lg font-semibold mb-2">Gestion des utilisateurs</h3>
            <input type="text" placeholder="Nom d'utilisateur" class="w-full mb-2 px-4 py-2 border rounded">
            <input type="password" placeholder="Mot de passe" class="w-full mb-2 px-4 py-2 border rounded">
            <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Ajouter</button>
          </div>
        </section>

        <section id="graph" class="hidden">
          <h2 class="text-2xl font-bold mb-6">Graphiques en Temps Réel</h2>

          <!-- Filtre de temps -->
          <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">De (date et heure)</label>
              <input type="datetime-local" id="startTime" class="border rounded px-3 py-2 w-full">
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">À (date et heure)</label>
              <input type="datetime-local" id="endTime" class="border rounded px-3 py-2 w-full">
            </div>
            <button onclick="filterData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Appliquer</button>
          </div>

          <!-- Les Graphiques -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <canvas id="humiditeChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <canvas id="temperatureChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <canvas id="vibrationChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <canvas id="acceleroChart"></canvas>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    let originalData = [];
    let charts = {};  // لحفظ الرسوم البيانية

    // دالة لجلب البيانات
    async function fetchData() {
      const response = await fetch("https://script.google.com/macros/s/AKfycby8FB58JbAnePfafVoZNfCGu6m9ie3_01u0SMVH310YYUZUWutx8Nla3noNW3HT0gCK/exec");
      const rawData = await response.json();

      // تنظيف وتحويل البيانات
      const cleanedData = rawData.map(item => {
        const date = new Date(item.Date);
        const time = new Date(item.Heure);
        
        const timestamp = new Date(
          date.getFullYear(), date.getMonth(), date.getDate(),
          time.getHours(), time.getMinutes(), time.getSeconds()
        );

        return {
          timestamp: timestamp.toISOString(),
          humidite: parseFloat(item["Humidité "] || 0),
          temperature: parseFloat(item["Température"] || 0),
          vibration: parseFloat(item["Vibration "] || 0),
          // حساب متوسط التسارع من القيم Accel_X, Accel_Y, Accel_Z
          accelero: Math.sqrt(
            Math.pow(item["Accel_X "] || 0, 2) +
            Math.pow(item["Accel_Y"] || 0, 2) +
            Math.pow(item["Accel_Z "] || 0, 2)
          )
        };
      });

      originalData = cleanedData;
      updateCharts(cleanedData);  // تحديث الرسوم البيانية بالبيانات المبدئية
    }

    // دالة لتحديث الرسوم البيانية
    function updateCharts(data) {
      const labels = data.map(item => item.timestamp);
      const humidite = data.map(item => item.humidite);
      const temperature = data.map(item => item.temperature);
      const vibration = data.map(item => item.vibration);
      const accelero = data.map(item => item.accelero);

      // إذا كانت الرسوم البيانية موجودة، نقوم بتحديثها
      if (charts['humiditeChart']) charts['humiditeChart'].destroy();
      if (charts['temperatureChart']) charts['temperatureChart'].destroy();
      if (charts['vibrationChart']) charts['vibrationChart'].destroy();
      if (charts['acceleroChart']) charts['acceleroChart'].destroy();

      // إنشاء الرسوم البيانية الجديدة
      charts['humiditeChart'] = new Chart(document.getElementById('humiditeChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Humidité (%)',
            data: humidite,
            borderColor: '#3b82f6',
            backgroundColor: '#3b82f633',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          }
        }
      });

      charts['temperatureChart'] = new Chart(document.getElementById('temperatureChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Température (°C)',
            data: temperature,
            borderColor: '#f97316',
            backgroundColor: '#f9731633',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          }
        }
      });

      charts['vibrationChart'] = new Chart(document.getElementById('vibrationChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Vibration',
            data: vibration,
            borderColor: '#10b981',
            backgroundColor: '#10b98133',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          }
        }
      });

      charts['acceleroChart'] = new Chart(document.getElementById('acceleroChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Accéléromètre',
            data: accelero,
            borderColor: '#9333ea',
            backgroundColor: '#9333ea33',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          }
        }
      });
    }

    // الدالة لتصفية البيانات حسب التاريخ
    function filterData() {
      const startTime = document.getElementById("startTime").value;
      const endTime = document.getElementById("endTime").value;
      
      if (startTime && endTime) {
        const filteredData = originalData.filter(item => {
          const timestamp = new Date(item.timestamp);
          return timestamp >= new Date(startTime) && timestamp <= new Date(endTime);
        });
        updateCharts(filteredData);  // تحديث الرسم البياني بالبيانات المفلترة
      }
    }

    // تفعيل التبديل بين الصفحات
    function showPage(page) {
      document.querySelectorAll('section').forEach(section => {
        section.classList.add('hidden');
      });
      document.getElementById(page).classList.remove('hidden');
    }

    // إغلاق الجلسة
    function logout() {
      // إعادة توجيه المستخدم لصفحة تسجيل الدخول
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    }

    // تسجيل الدخول
    function login() {
      // التحقق من بيانات الدخول (افتراضيًا يتم عرض الصفحة الرئيسية عند تسجيل الدخول)
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      fetchData();  // جلب البيانات عند تسجيل الدخول
    }

    // إظهار القائمة الجانبية عند النقر
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('transform');  // إخفاء/إظهار القائمة الجانبية
    });

    // جلب البيانات عند تحميل الصفحة
    window.onload = function() {
      fetchData();
    };
  </script>
</body>
</html>
