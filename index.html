<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#10b981" />
  <title>IoT Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <!-- Login Page -->
  <div id="loginPage" class="min-h-screen flex items-center justify-center">
    <div class="bg-white p-8 rounded shadow-md w-full max-w-sm">
      <h1 class="text-2xl font-bold mb-6 text-center">Connexion</h1>
      <input id="username" class="w-full mb-4 p-2 border rounded" type="text" placeholder="Nom d'utilisateur" />
      <input id="password" class="w-full mb-4 p-2 border rounded" type="password" placeholder="Mot de passe" />
      <button onclick="login()" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">Se connecter</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <!-- Navbar -->
    <nav class="bg-white shadow-md p-4 flex justify-between items-center">
      <div class="text-xl font-bold">Tableau de bord IoT</div>
      <div class="flex items-center gap-4">
        <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Déconnexion</button>
        <button id="sidebarToggle" class="md:hidden bg-gray-200 p-2 rounded">☰</button>
      </div>
    </nav>

    <!-- Content -->
    <div class="flex">
      <!-- Sidebar -->
      <aside id="sidebar" class="hidden md:flex flex-col w-64 bg-white p-4 shadow-md space-y-4">
        <button onclick="showPage('home')" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Accueil</button>
        <button onclick="showPage('graph')" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Graphiques</button>
        <button onclick="showPage('settings')" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Paramètres</button>
      </aside>

      <!-- Pages -->
      <main class="flex-1 p-6">
        <!-- Home Page -->
        <section id="home">
          <h2 class="text-2xl font-bold mb-4">Bienvenue</h2>
          <p class="text-gray-700">Sélectionnez une section depuis la barre latérale.</p>
        </section>

        <!-- Graph Page -->
        <section id="graph" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Graphiques des capteurs</h2>
          <button onclick="fetchData()" class="mb-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Actualiser les données</button>
          <canvas id="sensorChart" class="bg-white rounded shadow-md"></canvas>
        </section>

        <!-- Settings Page -->
        <section id="settings" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Paramètres</h2>
          <p class="text-gray-600">Fonctionnalités à venir...</p>
        </section>
      </main>
    </div>
  </div>

  <!-- Script -->
  <script>
    const chartColors = {
      temp: 'rgba(255, 99, 132, 0.7)',
      humidity: 'rgba(54, 162, 235, 0.7)',
      accel: 'rgba(75, 192, 192, 0.7)'
    };

    let sensorChart;

    function login() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();

      if (user === "admin" && pass === "1234") {
        localStorage.setItem("loggedIn", "true");
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        showPage("home");
      } else {
        alert("Identifiants incorrects.");
      }
    }

    function logout() {
      localStorage.removeItem("loggedIn");
      location.reload();
    }

    function showPage(page) {
      document.querySelectorAll("section").forEach(s => s.classList.add("hidden"));
      document.getElementById(page).classList.remove("hidden");

      if (page === "graph") {
        fetchData();
      }
    }

    async function fetchData() {
      try {
        const response = await fetch("https://opensheet.elk.sh/1cO0ToA3t7Vi5BqX13wXBbMVzPPCE4K7fEYsUjcZXXrI/Feuil1");
        const rawData = await response.json();

        const data = rawData.map(item => ({
          timestamp: new Date(item.timestamp).toLocaleString('fr-FR'),
          temperature: parseFloat(item.Temperature || 0),
          humidity: parseFloat(item.Humidity || 0),
          accelero: Math.sqrt(
            Math.pow(parseFloat(item["Accel_X "] || 0), 2) +
            Math.pow(parseFloat(item["Accel_Y"] || 0), 2) +
            Math.pow(parseFloat(item["Accel_Z "] || 0), 2)
          )
        }));

        updateChart(data);
      } catch (err) {
        alert("Erreur lors de la récupération des données.");
        console.error(err);
      }
    }

    function updateChart(data) {
      const labels = data.map(d => d.timestamp);
      const tempData = data.map(d => d.temperature);
      const humidData = data.map(d => d.humidity);
      const accelData = data.map(d => d.accelero);

      const ctx = document.getElementById("sensorChart").getContext("2d");

      if (sensorChart) sensorChart.destroy();

      sensorChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Température (°C)", data: tempData, borderColor: chartColors.temp, fill: false },
            { label: "Humidité (%)", data: humidData, borderColor: chartColors.humidity, fill: false },
            { label: "Accélération (g)", data: accelData, borderColor: chartColors.accel, fill: false },
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: "top" }, title: { display: true, text: "Capteurs en temps réel" } },
          scales: { x: { display: true, title: { display: true, text: "Heure" } } }
        }
      });
    }

    // INIT
    window.onload = () => {
      if (localStorage.getItem("loggedIn") === "true") {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("mainContent").style.display = "block";
        showPage("home");
      }

      document.getElementById("sidebarToggle").addEventListener("click", () => {
        document.getElementById("sidebar").classList.toggle("hidden");
      });
    };
  </script>
</body>
</html>
