<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة البيانات</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial;
      background-color: #f4f4f4;
    }
    .login-page, .main-page {
      display: none;
      height: 100vh;
    }
    .login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      background: #222;
      color: white;
    }
    .login-box {
      background: #333;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px #000;
    }
    .login-box input {
      width: 100%;
      margin: 10px 0;
      padding: 10px;
    }
    .sidebar {
      width: 200px;
      background: #2c3e50;
      color: white;
      position: fixed;
      height: 100%;
      padding-top: 20px;
    }
    .sidebar button {
      display: block;
      background: none;
      color: white;
      border: none;
      width: 100%;
      text-align: right;
      padding: 15px;
      cursor: pointer;
    }
    .content {
      margin-right: 200px;
      padding: 20px;
    }
    .filters {
      margin-bottom: 20px;
    }
    input[type="date"], input[type="time"] {
      margin-left: 10px;
      padding: 5px;
    }
    canvas {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
    }
  </style>
</head>
<body>

<div class="login-page" id="loginPage">
  <div class="login-box">
    <h2>تسجيل الدخول</h2>
    <input type="text" id="username" placeholder="اسم المستخدم" />
    <input type="password" id="password" placeholder="كلمة المرور" />
    <button onclick="login()">دخول</button>
  </div>
</div>

<div class="main-page" id="mainPage">
  <div class="sidebar">
    <button onclick="showChart('temp')">درجة الحرارة</button>
    <button onclick="showChart('humidity')">الرطوبة</button>
    <button onclick="showChart('accel')">التسارع</button>
    <button onclick="showChart('gyro')">الجيروسكوب</button>
    <button onclick="showChart('vibration')">الاهتزاز</button>
  </div>
  <div class="content">
    <div class="filters">
      <label>التاريخ:</label>
      <input type="date" id="dateFilter">
      <label>من:</label>
      <input type="time" id="timeFrom">
      <label>إلى:</label>
      <input type="time" id="timeTo">
      <button onclick="showChart(currentChart)">تحديث</button>
    </div>
    <canvas id="mainChart" width="1000" height="400"></canvas>
  </div>
</div>

<script>
  const correctUser = "admin";
  const correctPass = "1234";
  let currentChart = "temp";
  let chartInstance;
  let globalData = [];

  function login() {
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    if (u === correctUser && p === correctPass) {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('mainPage').style.display = 'block';
      showChart('temp');
    } else {
      alert("بيانات خاطئة!");
    }
  }

  async function fetchData() {
    const url = "https://script.google.com/macros/s/AKfycbyyOjiF-mX-oC2AeYB2antb3GMRKsMLfzegN6DRx5Q_XsceQMNOjAipsAMyxPI3Ca2NDA/exec";
    const response = await fetch(url);
    const json = await response.json();
    return json.map(row => ({
      time: row["Horodatage"],
      temp: parseFloat(row["Température (°C)"]),
      humidity: parseFloat(row["Humidité (%)"]),
      ax: parseFloat(row["Accélération X"]),
      ay: parseFloat(row["Accélération Y"]),
      az: parseFloat(row["Accélération Z"]),
      gx: parseFloat(row["Gyroscope X"]),
      gy: parseFloat(row["Gyroscope Y"]),
      gz: parseFloat(row["Gyroscope Z"]),
      vibration: parseFloat(row["Vibration"]),
      ntc: parseFloat(row["Temp. NTC (°C)"]),
      current: parseFloat(row["Courant (V Bruts)"]),
      battery: parseFloat(row["Batterie (V)"]),
    }));
  }

  async function showChart(type) {
    currentChart = type;
    if (globalData.length === 0) globalData = await fetchData();

    const date = document.getElementById('dateFilter').value;
    const timeFrom = document.getElementById('timeFrom').value;
    const timeTo = document.getElementById('timeTo').value;

    const filtered = globalData.filter(r => {
      const dt = new Date(r.time);
      if (date && dt.toISOString().slice(0, 10) !== date) return false;
      const t = dt.toTimeString().slice(0, 5);
      if (timeFrom && t < timeFrom) return false;
      if (timeTo && t > timeTo) return false;
      return true;
    });

    const labels = filtered.map(r => new Date(r.time).toLocaleTimeString());
    let datasets = [];

    switch (type) {
      case 'temp':
        datasets = [{ label: "درجة الحرارة °C", data: filtered.map(r => r.temp), borderColor: "red" }];
        break;
      case 'humidity':
        datasets = [{ label: "الرطوبة %", data: filtered.map(r => r.humidity), borderColor: "blue" }];
        break;
      case 'accel':
        datasets = [
          { label: "X", data: filtered.map(r => r.ax), borderColor: "green" },
          { label: "Y", data: filtered.map(r => r.ay), borderColor: "orange" },
          { label: "Z", data: filtered.map(r => r.az), borderColor: "purple" }
        ];
        break;
      case 'gyro':
        datasets = [
          { label: "X", data: filtered.map(r => r.gx), borderColor: "green" },
          { label: "Y", data: filtered.map(r => r.gy), borderColor: "orange" },
          { label: "Z", data: filtered.map(r => r.gz), borderColor: "purple" }
        ];
        break;
      case 'vibration':
        datasets = [{ label: "الاهتزاز", data: filtered.map(r => r.vibration), borderColor: "black" }];
        break;
    }

    if (chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('mainChart').getContext('2d');
    chartInstance = new Chart(ctx, {
      type: 'line',
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
      }
    });
  }
</script>

</body>
</html>
