<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }

    /* Loader Style */
    .loader {
      border-top-color: #3498db;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Loading Indicator -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-16 w-16"></div>
  </div>

  <!-- Login Page -->
  <div id="loginPage" class="flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
      <h2 class="text-2xl font-semibold text-center text-gray-800 mb-6">Connexion SÃ©curisÃ©e</h2>
      <input id="loginUser" type="text" placeholder="Nom d'utilisateur" class="w-full mb-4 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
      <input id="loginPass" type="password" placeholder="Mot de passe" class="w-full mb-6 px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
      <button onclick="login()" class="w-full bg-blue-600 text-white py-2 rounded-md font-semibold hover:bg-blue-700">Connexion</button>
    </div>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="hidden">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <aside id="sidebar" class="bg-gray-800 text-white space-y-4 py-6 px-4 flex flex-col justify-between transform transition-all duration-300 ease-in-out w-64 fixed inset-0 md:static md:flex md:h-auto z-10 md:w-64 md:hidden">
        <button id="sidebarToggle" class="text-white md:hidden absolute top-4 left-4">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="h-8 w-8">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        <nav class="space-y-2">
          <a href="#" onclick="showPage('home')" class="block px-4 py-2 rounded hover:bg-blue-600">ğŸ  Accueil</a>
          <a href="#" onclick="showPage('dashboard')" class="block px-4 py-2 rounded hover:bg-blue-600">ğŸ“Š Dashboard</a>
          <a href="#" onclick="showPage('settings')" class="block px-4 py-2 rounded hover:bg-blue-600">âš™ï¸ ParamÃ¨tres</a>
          <a href="#" onclick="showPage('graph')" class="block px-4 py-2 rounded hover:bg-blue-600">ğŸ“ˆ Graphiques</a>
        </nav>
        <button onclick="logout()" class="w-full bg-red-600 py-2 rounded-md text-white font-bold hover:bg-red-700">ğŸšª DÃ©connexion</button>
      </aside>

      <!-- Main Section -->
      <main class="flex-1 overflow-y-auto p-4 ml-64 md:ml-0">
        <section id="home">
          <h2 class="text-2xl font-bold mb-4">Bienvenue</h2>
          <p>SÃ©lectionnez une section pour afficher les donnÃ©es.</p>
        </section>

        <section id="dashboard" class="hidden">
          <h2 class="text-2xl font-bold mb-4">Tableau de bord</h2>
          <iframe src="https://docs.google.com/spreadsheets/d/1tqB-t3cDJiDhAHsgSGWJw7p4-pnE8pHHqubPHIStZ8c" class="w-full h-[500px] border rounded"></iframe>
        </section>

        <section id="settings" class="hidden">
          <h2 class="text-2xl font-bold mb-6">ParamÃ¨tres du compte</h2>
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Changer le mot de passe</h3>
            <input type="password" placeholder="Nouveau mot de passe" class="w-full mb-2 px-4 py-2 border rounded">
            <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Modifier</button>
          </div>

          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-2">Mettre Ã  jour le nom d'utilisateur</h3>
            <input type="text" placeholder="Nouveau nom d'utilisateur" class="w-full mb-2 px-4 py-2 border rounded">
            <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Mettre Ã  jour</button>
          </div>

          <div>
            <h3 class="text-lg font-semibold mb-2">Gestion des utilisateurs</h3>
            <input type="text" placeholder="Nom d'utilisateur" class="w-full mb-2 px-4 py-2 border rounded">
            <input type="password" placeholder="Mot de passe" class="w-full mb-2 px-4 py-2 border rounded">
            <button class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Ajouter</button>
          </div>
        </section>

        <section id="graph" class="hidden">
          <h2 class="text-2xl font-bold mb-6">Graphiques en Temps RÃ©el</h2>

          <!-- Filtre de temps -->
          <div class="flex flex-col sm:flex-row items-center gap-4 mb-6">
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">De (date et heure)</label>
              <input type="datetime-local" id="startTime" class="border rounded px-3 py-2 w-full">
            </div>
            <div class="flex-1">
              <label class="block text-sm font-medium text-gray-700 mb-1">Ã€ (date et heure)</label>
              <input type="datetime-local" id="endTime" class="border rounded px-3 py-2 w-full">
            </div>
            <button onclick="filterData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Appliquer</button>
          </div>

          <!-- Les Graphiques -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <canvas id="humiditeChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <canvas id="temperatureChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <canvas id="vibrationChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-lg">
              <canvas id="acceleroChart"></canvas>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
    let originalData = [];
    let charts = {};  // Ù„Ø­ÙØ¸ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©

    // Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function fetchData() {
      document.getElementById('loading').classList.remove('hidden');  // Ø¹Ø±Ø¶ Ø§Ù„Ù€ Loader

      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycby8FB58JbAnePfafVoZNfCGu6m9ie3_01u0SMVH310YYUZUWutx8Nla3noNW3HT0gCK/exec");
        const rawData = await response.json();
        console.log("Data fetched:", rawData);  // Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ±Ø¬Ø¹Ø©

        // ØªÙ†Ø¸ÙŠÙ ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const cleanedData = rawData.map(item => {
          const date = new Date(item.Date);
          const time = new Date(item.Heure);
          
          const timestamp = new Date(
            date.getFullYear(), date.getMonth(), date.getDate(),
            time.getHours(), time.getMinutes(), time.getSeconds()
          ).getTime();

          return {
            timestamp: timestamp,
            humidity: item.Humidite,
            temperature: item.TempÃ©rature,
            vibration: item.Vibration,
            accelero: item.Accelero
          };
        });

        originalData = cleanedData;
        updateCharts(cleanedData);

      } catch (error) {
        console.error("Error fetching data:", error);
      } finally {
        document.getElementById('loading').classList.add('hidden');  // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ Loader
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    function updateCharts(data) {
      if (charts.humidity) {
        charts.humidity.data.datasets[0].data = data.map(item => item.humidity);
        charts.humidity.update();
      }
      if (charts.temperature) {
        charts.temperature.data.datasets[0].data = data.map(item => item.temperature);
        charts.temperature.update();
      }
      if (charts.vibration) {
        charts.vibration.data.datasets[0].data = data.map(item => item.vibration);
        charts.vibration.update();
      }
      if (charts.accelero) {
        charts.accelero.data.datasets[0].data = data.map(item => item.accelero);
        charts.accelero.update();
      }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©
    function filterData() {
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;

      if (!startTime || !endTime) {
        alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ®ÙŠÙ† ØµØ§Ù„Ø­ÙŠÙ†.");
        return;
      }

      const filteredData = originalData.filter(item => {
        const timestamp = new Date(item.timestamp);
        return timestamp >= new Date(startTime) && timestamp <= new Date(endTime);
      });

      if (filteredData.length === 0) {
        alert("Aucune donnÃ©e disponible pour cette pÃ©riode.");
        return;
      }

      updateCharts(filteredData);  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª
    function showPage(page) {
      document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));
      document.getElementById(page).classList.remove('hidden');
    }

    // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    function logout() {
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    function login() {
      const user = document.getElementById('loginUser').value;
      const pass = document.getElementById('loginPass').value;

      if (user === 'admin' && pass === 'admin') {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
        fetchData();  // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
      } else {
        alert("Nom d'utilisateur ou mot de passe incorrect.");
      }
    }

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    window.onload = function() {
      const ctxHumidity = document.getElementById('humiditeChart').getContext('2d');
      charts.humidity = new Chart(ctxHumidity, {
        type: 'line',
        data: {
          labels: [], // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§
          datasets: [{
            label: 'HumiditÃ©',
            data: [],
            borderColor: 'rgba(75, 192, 192, 1)',
            fill: false
          }]
        }
      });

      const ctxTemperature = document.getElementById('temperatureChart').getContext('2d');
      charts.temperature = new Chart(ctxTemperature, {
        type: 'line',
        data: {
          labels: [], // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§
          datasets: [{
            label: 'TempÃ©rature',
            data: [],
            borderColor: 'rgba(255, 99, 132, 1)',
            fill: false
          }]
        }
      });

      const ctxVibration = document.getElementById('vibrationChart').getContext('2d');
      charts.vibration = new Chart(ctxVibration, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Vibration',
            data: [],
            borderColor: 'rgba(153, 102, 255, 1)',
            fill: false
          }]
        }
      });

      const ctxAccelero = document.getElementById('acceleroChart').getContext('2d');
      charts.accelero = new Chart(ctxAccelero, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'AccÃ©lÃ©romÃ¨tre',
            data: [],
            borderColor: 'rgba(255, 159, 64, 1)',
            fill: false
          }]
        }
      });
    };
  </script>

</body>
</html>
