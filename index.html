<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض بيانات جدول جوجل مع فلاتر</title>
    <!-- تضمين Tailwind CSS لتصميم عصري ومتجاوب -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* خط "Inter" لتحسين المظهر العام */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* لون خلفية خفيف */
        }
        /* تصميم أساسي للجدول */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background-color: #fff;
            border-radius: 0.5rem; /* حواف مستديرة للجدول */
            overflow: hidden; /* لإخفاء المحتوى الزائد الذي يتجاوز الحواف المستديرة */
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: right; /* محاذاة النص لليمين */
        }
        th {
            background-color: #4CAF50;
            color: white;
            text-transform: uppercase;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #ddd;
        }
        #loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2em;
            color: #555;
        }
    </style>
</head>
<body class="p-4 bg-gray-100 flex flex-col items-center min-h-screen">
    <!-- عنوان الصفحة -->
    <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-6 text-center">
        بيانات من جدول جوجل
    </h1>

    <!-- قسم فلاتر البيانات -->
    <div class="mb-6 w-full max-w-5xl bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold text-gray-700 mb-4 text-center">فلاتر البيانات</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
            <div>
                <label for="filterDateFrom" class="block text-sm font-medium text-gray-700 text-right">تاريخ من:</label>
                <input type="date" id="filterDateFrom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 text-right dir-rtl">
            </div>
            <div>
                <label for="filterDateTo" class="block text-sm font-medium text-gray-700 text-right">تاريخ إلى:</label>
                <input type="date" id="filterDateTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 text-right dir-rtl">
            </div>
            <div>
                <label for="filterTimeFrom" class="block text-sm font-medium text-gray-700 text-right">توقيت من:</label>
                <input type="time" id="filterTimeFrom" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 text-right dir-rtl">
            </div>
            <div>
                <label for="filterTimeTo" class="block text-sm font-medium text-gray-700 text-right">توقيت إلى:</label>
                <input type="time" id="filterTimeTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 text-right dir-rtl">
            </div>
        </div>
        <div class="flex flex-col sm:flex-row gap-4">
            <button id="applyFilterBtn" class="flex-1 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                تطبيق الفلتر
            </button>
            <button id="clearFilterBtn" class="flex-1 px-4 py-2 bg-gray-400 text-white font-semibold rounded-md shadow-md hover:bg-gray-500 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2 transition duration-150 ease-in-out">
                مسح الفلاتر
            </button>
        </div>
    </div>

    <!-- رسالة التحميل -->
    <div id="loading" class="text-lg text-gray-600 mb-4 animate-pulse">
        جاري تحميل البيانات...
    </div>

    <!-- حاوية الجدول حيث سيتم عرض البيانات -->
    <div id="table-container" class="w-full max-w-5xl bg-white shadow-lg rounded-lg overflow-x-auto">
        <!-- سيتم إدراج الجدول هنا بواسطة JavaScript -->
    </div>

    <script>
        // رابط Google Apps Script الخاص بك (تم التحديث)
        const SCRIPT_URL = "https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLiU-W7n7T4VpfLUNKsQwjCH1smHhHPTfZgRnZ8izioCny4R0S36aNMmQQwfdlM98DWwVgcE4KkMiohRixcODrNym0uRriEbIkwJxdtJIsV5w71W4MGb2j4-S4nQf27YXavHO-RqjX1S69aSy5V2bJtFOoknjjyl-r3Npdu0eFwmi85UecADqup3-CmtfXIkeIGy0uLRmnSXzZyr4fFr1v1gXnCZPDro1cUL21MBEcByO5r47j9-7izvX2H0vtqHKc6oSKnvVync9TeLvCWnBk99i9A5J2dMROS7Lycj&lib=M4KMr7SB6nroV6p0oLzbJNWtZyck6V9xg";

        // متغير لتخزين جميع البيانات التي تم جلبها من جدول جوجل
        let allSheetData = [];

        // ******** إعدادات الأعمدة (يرجى تعديلها حسب أسماء الأعمدة في جدولك) ********
        // اسم عمود التاريخ في جدول جوجل (مثال: "DATE")
        // تأكد من مطابقة حالة الأحرف تمامًا (أحرف كبيرة)
        const DATE_COLUMN_NAME = "DATE"; 
        // اسم عمود التوقيت في جدول جوجل (مثال: "HEURE")
        // تأكد من مطابقة حالة الأحرف تمامًا (أحرف كبيرة)
        const TIME_COLUMN_NAME = "HEURE"; 
        // *******************************************************************

        /**
         * دالة مساعدة لتنسيق التاريخ إلى YYYY-MM-DD
         * @param {Date} date - كائن التاريخ.
         * @returns {string} التاريخ المنسق.
         */
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0'); // الأشهر تبدأ من 0
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        /**
         * دالة مساعدة لتنسيق التوقيت إلى HH:MM
         * @param {Date} date - كائن التاريخ (يحتوي على التوقيت).
         * @returns {string} التوقيت المنسق.
         */
        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        /**
         * دالة لجلب البيانات من Google Apps Script API.
         * تُظهر رسالة تحميل وتُخفيها بعد اكتمال الجلب.
         */
        async function fetchData() {
            const loadingElement = document.getElementById("loading");
            const tableContainer = document.getElementById("table-container");

            loadingElement.style.display = "block"; // إظهار رسالة التحميل

            try {
                // استخدام Fetch API لجلب البيانات
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                allSheetData = data; // تخزين البيانات الأصلية
                displayData(allSheetData); // عرض جميع البيانات في الجدول مبدئياً
            } catch (error) {
                console.error("Error fetching data:", error);
                // عرض رسالة خطأ إذا فشل الجلب
                tableContainer.innerHTML = `
                    <div class="p-6 text-red-600 text-center">
                        <p class="font-semibold mb-2">فشل تحميل البيانات.</p>
                        <p>يرجى التحقق من رابط السكربت وأذونات النشر.</p>
                        <p>تفاصيل الخطأ: ${error.message}</p>
                    </div>
                `;
            } finally {
                loadingElement.style.display = "none"; // إخفاء رسالة التحميل
            }
        }

        /**
         * دالة لتطبيق الفلاتر (التاريخ والتوقيت) على البيانات.
         * تقرأ القيم من حقول الإدخال وتقوم بتصفية البيانات المخزنة.
         */
        function applyFilters() {
            const filterDateFromValue = document.getElementById("filterDateFrom").value;
            const filterDateToValue = document.getElementById("filterDateTo").value;
            const filterTimeFromValue = document.getElementById("filterTimeFrom").value;
            const filterTimeToValue = document.getElementById("filterTimeTo").value;

            // إذا لم يتم جلب البيانات بعد، لا تفعل شيئاً
            if (allSheetData.length === 0) {
                console.warn("No data to filter. Please wait for data to load.");
                return;
            }

            // البدء بجميع البيانات ثم تطبيق الفلاتر تدريجياً
            let filteredData = [...allSheetData]; // عمل نسخة للبيانات لتصفيتها

            // فلترة حسب التاريخ
            if (filterDateFromValue || filterDateToValue) {
                filteredData = filteredData.filter(row => {
                    const rowDateStr = row[DATE_COLUMN_NAME];
                    // تخطي الصفوف التي لا تحتوي على عمود التاريخ المحدد
                    if (!rowDateStr) return false;

                    const rowDate = new Date(rowDateStr); // تحويل تاريخ الصف إلى كائن Date
                    // لضمان مقارنة صحيحة لليوم بأكمله، يتم تعيين الوقت إلى بداية اليوم
                    rowDate.setHours(0, 0, 0, 0);

                    let dateMatch = true;

                    // فلتر "من" التاريخ
                    if (filterDateFromValue) {
                        const fromDateObj = new Date(filterDateFromValue);
                        fromDateObj.setHours(0, 0, 0, 0); // بداية اليوم
                        if (rowDate < fromDateObj) {
                            dateMatch = false;
                        }
                    }
                    // فلتر "إلى" التاريخ
                    if (filterDateToValue) {
                        const toDateObj = new Date(filterDateToValue);
                        toDateObj.setHours(23, 59, 59, 999); // نهاية اليوم
                        if (rowDate > toDateObj) {
                            dateMatch = false;
                        }
                    }
                    return dateMatch;
                });
            }

            // فلترة حسب التوقيت
            if (filterTimeFromValue || filterTimeToValue) {
                filteredData = filteredData.filter(row => {
                    const rowTimeStr = row[TIME_COLUMN_NAME];
                    // تخطي الصفوف التي لا تحتوي على عمود التوقيت المحدد
                    if (!rowTimeStr) return false;

                    // لإنشاء كائن Date من التوقيت فقط، نستخدم تاريخ وهمي
                    const dummyDate = "2000-01-01T"; // أي تاريخ ثابت

                    // التأكد من أن التوقيت يحتوي على ثوانٍ لتجنب مشاكل التحويل
                    let fullRowTimeStr = rowTimeStr;
                    if (rowTimeStr.split(':').length === 2) { // إذا كان HH:MM فقط
                        fullRowTimeStr += ':00'; // أضف الثواني الافتراضية
                    }
                    const rowDateTime = new Date(dummyDate + fullRowTimeStr);

                    let timeMatch = true;

                    // فلتر "من" التوقيت
                    if (filterTimeFromValue) {
                        let fullFilterTimeFrom = filterTimeFromValue;
                        if (filterTimeFromValue.split(':').length === 2) {
                            fullFilterTimeFrom += ':00';
                        }
                        const fromDateTime = new Date(dummyDate + fullFilterTimeFrom);
                        if (rowDateTime < fromDateTime) {
                            timeMatch = false;
                        }
                    }
                    // فلتر "إلى" التوقيت
                    if (filterTimeToValue) {
                        let fullFilterTimeTo = filterTimeToValue;
                        if (filterTimeToValue.split(':').length === 2) {
                            fullFilterTimeTo += ':59'; // لتضمين الدقيقة كاملة
                        }
                        const toDateTime = new Date(dummyDate + fullFilterTimeTo);
                        if (rowDateTime > toDateTime) {
                            timeMatch = false;
                        }
                    }
                    return timeMatch;
                });
            }

            // عرض البيانات المصفاة
            displayData(filteredData);
        }

        /**
         * دالة لمسح جميع قيم الفلاتر وإعادة عرض البيانات الأصلية.
         */
        function clearFilters() {
            document.getElementById("filterDateFrom").value = "";
            document.getElementById("filterDateTo").value = "";
            document.getElementById("filterTimeFrom").value = "";
            document.getElementById("filterTimeTo").value = "";
            displayData(allSheetData); // عرض جميع البيانات الأصلية مرة أخرى
        }

        /**
         * دالة لتحويل سلسلة ISO Date/Time إلى تنسيق تاريخ فقط (YYYY-MM-DD).
         * @param {string} isoString - سلسلة تاريخ ISO (مثل "2025-06-22T23:00:00.000Z").
         * @returns {string} التاريخ المنسق (YYYY-MM-DD).
         */
        function formatIsoDateOnly(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                // تحقق مما إذا كان التاريخ صالحًا
                if (isNaN(date.getTime())) {
                    // إذا لم يكن التاريخ صالحًا، حاول استخراج التاريخ من الجزء الأول من السلسلة
                    const datePart = isoString.split('T')[0];
                    const recheckedDate = new Date(datePart);
                    if (!isNaN(recheckedDate.getTime())) {
                        return datePart; // إذا كان الجزء الأول تاريخًا صالحًا، أرجعه
                    }
                    return isoString; // إرجاع السلسلة الأصلية إذا فشل التحويل تمامًا
                }
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                console.error("Error parsing ISO date string:", isoString, e);
                return isoString; // Return original if parsing fails
            }
        }

        /**
         * دالة لتحويل سلسلة ISO Date/Time إلى تنسيق وقت فقط (HH:MM:SS).
         * @param {string} isoString - سلسلة تاريخ ISO (مثل "1899-12-30T17:27:03.000Z").
         * @returns {string} التوقيت المنسق (HH:MM:SS).
         */
        function formatIsoTimeOnly(isoString) {
            if (!isoString) return '';
            try {
                const date = new Date(isoString);
                 // تحقق مما إذا كان التاريخ صالحًا
                if (isNaN(date.getTime())) {
                    // إذا لم يكن التاريخ صالحًا، حاول استخراج الوقت من الجزء الثاني من السلسلة
                    const timePart = isoString.split('T')[1];
                    if (timePart) {
                        const timeSegments = timePart.split(':');
                        if (timeSegments.length >= 2) {
                            const hours = timeSegments[0].padStart(2, '0');
                            const minutes = timeSegments[1].padStart(2, '0');
                            // اقتطع الثواني لتجنب أجزاء المللي ثانية إذا كانت موجودة
                            const seconds = timeSegments.length > 2 ? timeSegments[2].substring(0,2).padStart(2, '0') : '00';
                             return `${hours}:${minutes}:${seconds}`;
                        }
                    }
                    return isoString; // إرجاع السلسلة الأصلية إذا فشل التحويل تمامًا
                }
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                const seconds = String(date.getSeconds()).padStart(2, '0');
                return `${hours}:${minutes}:${seconds}`;
            } catch (e) {
                console.error("Error parsing ISO time string:", isoString, e);
                return isoString; // Return original if parsing fails
            }
        }


        /**
         * دالة لعرض البيانات المُستلمة في جدول HTML.
         * @param {Array<Object>} data - مصفوفة الكائنات التي تمثل صفوف البيانات.
         */
        function displayData(data) {
            const tableContainer = document.getElementById("table-container");

            // إذا لم تكن هناك بيانات أو كانت فارغة
            if (!data || data.length === 0) {
                tableContainer.innerHTML = `
                    <div class="p-6 text-gray-600 text-center">
                        <p>لا توجد بيانات متاحة لعرضها بعد التصفية.</p>
                    </div>
                `;
                return;
            }

            // إنشاء عناصر الجدول ديناميكيًا
            const table = document.createElement("table");
            table.className = "min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden";

            const thead = document.createElement("thead");
            thead.className = "bg-gray-50";

            const tbody = document.createElement("tbody");
            tbody.className = "bg-white divide-y divide-gray-200";

            // إنشاء صف الرؤوس (Headers)
            const headers = Object.keys(data[0]); // الحصول على أسماء الأعمدة من الكائن الأول
            const headerRow = document.createElement("tr");
            headers.forEach(headerText => {
                const th = document.createElement("th");
                th.textContent = headerText;
                // تطبيق فئات Tailwind CSS على رؤوس الجدول
                th.className = "px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider";
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // إنشاء صفوف البيانات (Rows)
            data.forEach((rowData, index) => {
                const tr = document.createElement("tr");
                // تطبيق فئات Tailwind CSS على الصفوف (للتلوين المتناوب hover)
                tr.className = index % 2 === 0 ? "bg-white" : "bg-gray-50";

                headers.forEach(headerText => {
                    const td = document.createElement("td");
                    let cellContent = rowData[headerText];

                    // ************ رسائل تصحيح للمطور ************
                    console.log(`Processing column: ${headerText}, Original content: ${cellContent}`);
                    // ********************************************

                    // تطبيق التنسيق للتاريخ والتوقيت إذا كانت الأعمدة مطابقة
                    if (headerText === DATE_COLUMN_NAME) {
                        const formattedDate = formatIsoDateOnly(cellContent);
                        console.log(`  Formatted DATE: ${formattedDate}`); // رسالة تصحيح
                        cellContent = formattedDate;
                    } else if (headerText === TIME_COLUMN_NAME) {
                        const formattedTime = formatIsoTimeOnly(cellContent);
                        console.log(`  Formatted HEURE: ${formattedTime}`); // رسالة تصحيح
                        cellContent = formattedTime;
                    }
                    
                    // استخدام textContent لضمان التعامل الآمن مع النصوص
                    td.textContent = cellContent;
                    // تطبيق فئات Tailwind CSS على خلايا البيانات
                    td.className = "px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right";
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            // مسح المحتوى القديم وإضافة الجدول الجديد إلى الحاوية
            tableContainer.innerHTML = "";
            tableContainer.appendChild(table);
        }

        // استدعاء دالة جلب البيانات عند تحميل محتوى DOM بالكامل
        document.addEventListener("DOMContentLoaded", () => {
            fetchData(); // جلب البيانات أولاً
            // إضافة مستمعي الأحداث لأزرار الفلاتر
            document.getElementById("applyFilterBtn").addEventListener("click", applyFilters);
            document.getElementById("clearFilterBtn").addEventListener("click", clearFilters);
        });
    </script>
</body>
</html>
